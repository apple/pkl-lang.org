amends "package://pkg.pkl-lang.org/pkl-pantry/com.circleci.v2@1.6.1#/Config.pkl"

jobs {
  ["deploy"] {
    docker {
      new {
        image = "cimg/openjdk:17.0"
      }
    }
    steps {
      "checkout"
      new RunStep {
        name = "Install toolchain"
        command = """
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          . "$HOME/.cargo/env"
          rustup default stable
          """
      }
      new RunStep {
        name = "Running deployment"
        command = #"""
          . "$HOME/.cargo/env"
          cat \<<EOF > ~/.cargo/config
          [net]
          git-fetch-with-cli = true
          EOF
          ./gradlew \
            --console=plain \
            pklHtmlHighlighter

          ./gradlew \
            --console=plain \
            npmInstall buildRemoteSite publishRemoteSite
          """#
      }
    }
  }
}

workflows {
  ["main"] {
    jobs {
      "deploy"
    }
    `when` {
      equal {
        "^main|gh-readonly-queue/main/pr-\\d+-[0-9a-f]{40}.*$"
        module.pipelineValues.`pipeline.git.branch`
      }
    }
  }
}
